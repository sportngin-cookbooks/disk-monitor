#!/bin/sh

function alert_json {
  echo "{" \
          "\"routing_key\": \"<%= @pd_service_key %>\"," \
          "\"event_action\": \"trigger\"," \
          "\"payload\": {" \
            "\"summary\": \"<%= @app_name %> <%= @environment %> running low on disk space $1($2%) <%= @hostname %>\"," \
            "\"source\": \"<%= @app_name %>-<%= @environment %>-<%= @hostname %>\"," \
            "\"severity\": \"<%= @urgency %>\"" \
          "}" \
       "}"
}

function alert {
curl -H "Content-type: application/json" -X POST \
  -d "$(alert_json $1 $2)" \
  "https://events.pagerduty.com/v2/enqueue"
}

df -H | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{ print $5 " " $1 }' | while read output;
do
  echo $output
  usep=$(echo $output | awk '{ print $1}' | cut -d'%' -f1  )
  partition=$(echo $output | awk '{ print $2 }' )
  if [ $usep -ge <%= @alerting_threshold %> ]; then
    alert $partition $usep
  fi
done
